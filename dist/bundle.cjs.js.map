{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Router from 'koa-router';\nimport koaBody from 'koa-body';\nimport shortId from 'shortid';\n\nconst router = Router();\n\nfunction addTrace(config) {\n  if (config && config.trace && config.trace.disabled) {\n    return (ctx, next) => {\n      return next();\n    };\n  }\n\n  return async (ctx, next) => {\n    let traceId = ctx.get('x-trace-id') || shortId();\n    if (global.als) {\n      global.als.set('traceId', traceId);\n    }\n    ctx.set('x-trace-id', traceId);\n    await next();\n  };\n}\n\nfunction lift() {\n  if (!global.Errors) {\n    throw new Error('no global Errors found');\n  }\n\n  if (!global.logger) {\n    throw new Error('no global logger found');\n  }\n\n  this.app.use(koaBody());\n\n  _.forEach((this.config.http || {}).middlewares || [], (middleware) => {\n    if (_.isFunction(middleware)) {\n      this.app.use(middleware());\n      return;\n    }\n\n    if (_.isArray(middleware)) {\n      let middlewareArr = _.map(middleware, (arg) => {\n        if (_.isFunction(arg)) {\n          return arg();\n        }\n        return arg;\n      });\n\n      this.app.use(middlewareArr);\n    }\n  });\n\n  _.forEach(this.config.routes, (action, key) => {\n    let method;\n    let pattern;\n    let index = key.indexOf(' ');\n    let allMethods = ['all', 'get', 'post', 'put', 'delete', 'patch'];\n\n    if (index > -1) {\n      let keyParts = [key.slice(0, index), key.slice(index + 1)];\n      method = (keyParts[0] || '').toLowerCase();\n      [, pattern] = keyParts;\n    }\n    else {\n      method = 'all';\n      pattern = key;\n    }\n\n    if (!_.includes(allMethods, method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    if (_.isFunction(action)) {\n      router[method](...[pattern].concat(action));\n      return;\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    let wrapActionMethod = function wrapActionMethod(ctx, ...args) {\n      return Promise.try(() => {\n        return actionMethod(...[ctx, ...args]);\n      })\n        .then((data) => {\n          if (!ctx.body) {\n            ctx.body = data;\n          }\n          return data;\n        })\n        .catch(Errors.OperationalError, (err) => {\n          logger.warn(err);\n          // koa 默认 status为404, 改成 400\n          ctx.status = ctx.status === 404 ? 400 : ctx.status;\n          ctx.body = err.response();\n        })\n        .catch((err) => {\n          logger.warn(err);\n          ctx.status = ctx.status === 404 ? 400 : ctx.status;\n          ctx.body = new Errors.Unknown().response();\n        });\n    };\n\n    let policies =\n      (this.controllerActionPolicies &&\n        this.controllerActionPolicies[`${controllerName}.${actionMethodName}`]) ||\n      [];\n\n    const funList = [pattern].concat(policies).concat(wrapActionMethod);\n    router.use(addTrace(this.config))[method](...funList);\n  });\n\n  this.app.use(router.routes());\n  this.app.use(router.allowedMethods());\n}\n\nexport default lift;\n"],"names":["router","Router","addTrace","config","trace","disabled","ctx","next","traceId","get","shortId","global","als","set","lift","Errors","Error","logger","app","use","koaBody","forEach","http","middlewares","middleware","_","isFunction","isArray","middlewareArr","map","arg","routes","action","key","method","pattern","index","indexOf","allMethods","keyParts","slice","toLowerCase","includes","concat","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","wrapActionMethod","args","Promise","try","then","data","body","catch","OperationalError","err","warn","status","response","Unknown","policies","controllerActionPolicies","funList","allowedMethods"],"mappings":"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"}