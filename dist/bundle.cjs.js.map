{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Router from 'koa-router';\nimport koaBody from 'koa-body';\nimport shortId from 'shortid';\n\nconst router = Router();\n\nfunction addTrace(config) {\n  if (config && config.trace && config.trace.disabled) {\n    return (ctx, next) => {\n      return next();\n    };\n  }\n\n  return async (ctx, next) => {\n    let traceId = ctx.get('x-trace-id') || shortId();\n    if (global.als) {\n      global.als.set('traceId', traceId);\n    }\n    ctx.set('x-trace-id', traceId);\n    await next();\n  };\n}\n\nfunction lift() {\n  if (!global.Errors) {\n    throw new Error('no global Errors found');\n  }\n\n  if (!global.logger) {\n    throw new Error('no global logger found');\n  }\n\n  this.app.use(koaBody());\n\n  _.forEach((this.config.http || {}).middlewares || [], (middleware) => {\n    if (_.isFunction(middleware)) {\n      this.app.use(middleware());\n      return;\n    }\n\n    if (_.isArray(middleware)) {\n      let middlewareArr = _.map(middleware, (arg) => {\n        if (_.isFunction(arg)) {\n          return arg();\n        }\n        return arg;\n      });\n\n      this.app.use(middlewareArr);\n    }\n  });\n\n  _.forEach(this.config.routes, (action, key) => {\n    let method;\n    let pattern;\n    let index = key.indexOf(' ');\n    let allMethods = ['all', 'get', 'post', 'put', 'delete', 'patch'];\n\n    if (index > -1) {\n      let keyParts = [key.slice(0, index), key.slice(index + 1)];\n      method = (keyParts[0] || '').toLowerCase();\n      [, pattern] = keyParts;\n    }\n    else {\n      method = 'all';\n      pattern = key;\n    }\n\n    if (!_.includes(allMethods, method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    if (_.isFunction(action)) {\n      router[method](...[pattern].concat(action));\n      return;\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    let wrapActionMethod = function wrapActionMethod(ctx, ...args) {\n      return Promise.try(() => {\n        return actionMethod(...[ctx, ...args]);\n      })\n        .then((data) => {\n          if (!ctx.body) {\n            ctx.body = data;\n          }\n          return data;\n        })\n        .catch(Errors.OperationalError, (err) => {\n          logger.warn(err);\n          // koa 默认 status为404, 改成 400\n          ctx.status = ctx.status === 404 ? 400 : ctx.status;\n          ctx.body = err.response();\n        })\n        .catch((err) => {\n          logger.warn(err);\n          ctx.status = ctx.status === 404 ? 400 : ctx.status;\n          ctx.body = new Errors.Unknown().response();\n        });\n    };\n\n    let policies =\n      (this.controllerActionPolicies &&\n        this.controllerActionPolicies[`${controllerName}.${actionMethodName}`]) ||\n      [];\n\n    const funList = [pattern].concat(policies).concat(wrapActionMethod);\n    router[method](...funList);\n  });\n\n  this.app.use(addTrace(this.config));\n  this.app.use(router.routes());\n  this.app.use(router.allowedMethods());\n}\n\nexport default lift;\n"],"names":["router","Router","addTrace","config","trace","disabled","ctx","next","traceId","get","shortId","global","als","set","lift","Errors","Error","logger","app","use","koaBody","_","forEach","http","middlewares","middleware","isFunction","isArray","middlewareArr","map","arg","routes","action","key","method","pattern","index","indexOf","allMethods","keyParts","slice","toLowerCase","includes","concat","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","wrapActionMethod","args","Promise","try","then","data","body","catch","OperationalError","err","warn","status","response","Unknown","policies","controllerActionPolicies","funList","allowedMethods"],"mappings":"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"}