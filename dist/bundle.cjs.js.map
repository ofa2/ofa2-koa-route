{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Router from 'koa-router';\nimport bodyParser from 'koa-bodyparser';\n\nconst router = Router();\n\nfunction lift() {\n  this.app.use(bodyParser());\n  _.forEach((this.config.http || {}).middlewares || [], (middleware) => {\n    if (_.isFunction(middleware)) {\n      this.app.use(middleware());\n      return;\n    }\n\n    if (_.isArray(middleware)) {\n      let middlewareArr = _.map(middleware, (arg) => {\n        if (_.isFunction(arg)) {\n          return arg();\n        }\n        return arg;\n      });\n\n      this.app.use(middlewareArr);\n    }\n  });\n\n  _.forEach(this.config.routes, (action, key) => {\n    let method;\n    let pattern;\n    let index = key.indexOf(' ');\n    let allMethods = ['all', 'get', 'post', 'put', 'delete', 'patch'];\n\n    if (index > -1) {\n      let keyParts = [key.slice(0, index), key.slice(index + 1)];\n      method = (keyParts[0] || '').toLowerCase();\n      [, pattern] = keyParts;\n    }\n    else {\n      method = 'all';\n      pattern = key;\n    }\n\n    if (!_.includes(allMethods, method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    if (_.isFunction(action)) {\n      router[method](...[pattern].concat(action));\n      return;\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    let wrapActionMethod = function wrapActionMethod(ctx, ...args) {\n      return Promise.try(() => {\n        return actionMethod(...[ctx, ...args]);\n      })\n        .then((data) => {\n          if (!ctx.body) {\n            ctx.body = data;\n          }\n          return data;\n        })\n        .catch(global.Errors, (err) => {\n          global.logger.warn(err);\n          ctx.status = ctx.status || 400;\n          ctx.body = err;\n        })\n        .catch((err) => {\n          global.logger.warn(err);\n          ctx.status = ctx.status || 400;\n        });\n    };\n\n    let policies =\n      (this.controllerActionPolicies &&\n        this.controllerActionPolicies[`${controllerName}.${actionMethodName}`]) ||\n      [];\n\n    router[method](...[pattern].concat(policies).concat(wrapActionMethod));\n  });\n\n  this.app.use(router.routes());\n  this.app.use(router.allowedMethods());\n}\n\nexport default lift;\n"],"names":["router","Router","lift","app","use","bodyParser","forEach","config","http","middlewares","middleware","_","isFunction","isArray","middlewareArr","map","arg","routes","action","key","method","pattern","index","indexOf","allMethods","keyParts","slice","toLowerCase","includes","Error","concat","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","wrapActionMethod","ctx","args","Promise","try","then","data","body","catch","global","Errors","err","logger","warn","status","policies","controllerActionPolicies","allowedMethods"],"mappings":"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"}