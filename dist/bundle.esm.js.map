{"version":3,"file":"bundle.esm.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Router from 'koa-router';\nimport koaBody from 'koa-body';\nimport shortId from 'shortid';\n\nconst router = Router();\n\nfunction addTrace(config) {\n  if (config && config.trace && config.trace.disabled) {\n    return (ctx, next) => {\n      return next();\n    };\n  }\n\n  return async (ctx, next) => {\n    let traceId = ctx.get('x-trace-id') || shortId();\n    if (global.als) {\n      global.als.set('traceId', traceId);\n    }\n    ctx.set('x-trace-id', traceId);\n    await next();\n  };\n}\n\nfunction addCatch() {\n  return async (ctx, next) => {\n    try {\n      await next();\n    }\n    catch (err) {\n      logger.warn(err);\n\n      if (err instanceof Errors.OperationalError) {\n        ctx.status = ctx.status === 404 ? 400 : ctx.status;\n        ctx.body = err.response();\n      }\n      else {\n        ctx.status = ctx.status === 404 ? 400 : ctx.status;\n        ctx.body = new Errors.Unknown().response();\n      }\n    }\n  };\n}\n\nfunction lift() {\n  if (!global.Errors) {\n    throw new Error('no global Errors found');\n  }\n\n  if (!global.logger) {\n    throw new Error('no global logger found');\n  }\n\n  this.app.use(koaBody());\n\n  _.forEach((this.config.http || {}).middlewares || [], (middleware) => {\n    if (_.isFunction(middleware)) {\n      this.app.use(middleware());\n      return;\n    }\n\n    if (_.isArray(middleware)) {\n      let middlewareArr = _.map(middleware, (arg) => {\n        if (_.isFunction(arg)) {\n          return arg();\n        }\n        return arg;\n      });\n\n      this.app.use(middlewareArr);\n    }\n  });\n\n  _.forEach(this.config.routes, (action, key) => {\n    let method;\n    let pattern;\n    let index = key.indexOf(' ');\n    let allMethods = ['all', 'get', 'post', 'put', 'delete', 'patch'];\n\n    if (index > -1) {\n      let keyParts = [key.slice(0, index), key.slice(index + 1)];\n      method = (keyParts[0] || '').toLowerCase();\n      [, pattern] = keyParts;\n    }\n    else {\n      method = 'all';\n      pattern = key;\n    }\n\n    if (!_.includes(allMethods, method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    if (_.isFunction(action)) {\n      router[method](...[pattern].concat(action));\n      return;\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    let wrapActionMethod = function wrapActionMethod(ctx, ...args) {\n      return Promise.try(() => {\n        return actionMethod(...[ctx, ...args]);\n      }).then((data) => {\n        if (!ctx.body) {\n          ctx.body = data;\n        }\n        return data;\n      });\n    };\n\n    let policies =\n      (this.controllerActionPolicies &&\n        this.controllerActionPolicies[`${controllerName}.${actionMethodName}`]) ||\n      [];\n\n    const funList = [pattern].concat(policies).concat(wrapActionMethod);\n    router[method](...funList);\n  });\n\n  this.app.use(addTrace(this.config));\n  this.app.use(addCatch());\n  this.app.use(router.routes());\n  this.app.use(router.allowedMethods());\n}\n\nexport default lift;\n"],"names":["router","Router","addTrace","config","trace","disabled","ctx","next","traceId","get","shortId","global","als","set","addCatch","err","logger","warn","Errors","OperationalError","status","body","response","Unknown","lift","Error","app","use","koaBody","_","forEach","http","middlewares","middleware","isFunction","isArray","middlewareArr","map","arg","routes","action","key","method","pattern","index","indexOf","allMethods","keyParts","slice","toLowerCase","includes","concat","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","wrapActionMethod","args","Promise","try","then","data","policies","controllerActionPolicies","funList","allowedMethods"],"mappings":"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"}